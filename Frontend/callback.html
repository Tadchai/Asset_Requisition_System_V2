<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Callback</title>
</head>

<body>
    <script type="module">
        import { clientId, clientSecret, API_URL} from './assets/config.js';
        (async () =>
        {
            try
            {
                const urlParams = new URLSearchParams(window.location.search); //ใส่stateด้วย
                const code = urlParams.get("code");

                const params = new URLSearchParams();
                params.append("client_id", `${clientId}`);
                params.append("client_secret", `${clientSecret}`);
                params.append("grant_type", "authorization_code");
                params.append("code", code);
                params.append( "redirect_uri","http://127.0.0.1:5002/Frontend/Callback.html");

                const accessResponse = await fetch(
                    "http://localhost:8080/realms/Requisition/protocol/openid-connect/token",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: params,
                    }
                );

                const accessData = await accessResponse.json();
                localStorage.setItem("token", accessData.access_token);

                const tokenResponse = await fetch(
                    `${API_URL}/Auth/CheckSubject`, {
                        headers: {
                            'Authorization': `Bearer ${accessData.access_token}`,
                        }
                    });
                if (tokenResponse.status == 200)
                {
                    window.location.href = "/Frontend/ManageAsset.html";
                } else
                {
                    alert(result.message);
                }
            } catch (error)
            {
                console.error("Error :", error);
            }
        })();
    </script>
</body>

</html>